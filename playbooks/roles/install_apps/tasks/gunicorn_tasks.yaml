---
# Directory created in wp_tasks.yaml.  Could be moved here :)
- name: create gunicorn nginx config
  become: yes
  template:
    src: templates/gunicorn.conf.j2
    dest: "/opt/bitnami/nginx/conf/server_blocks/{{ item.key }}.conf"
    owner: bitnami
    group: daemon
    mode: '0664'
  loop: "{{ APPs | dict2items }}"
  when: item.value.using_gunicorn is defined and item.value.using_gunicorn
  notify:
    - Restart bitnami apps

- name: install gunicorn
  pip:
    name: gunicorn
    virtualenv_python: "{{ item.value.which_python }}"
    virtualenv_command: "{{ item.value.whereis_virtualenv }}"
    virtualenv: "/opt/bitnami/apps/{{ item.key }}/venv"
  loop: "{{ APPs | dict2items }}"
  when: item.value.using_gunicorn is defined and item.value.using_gunicorn
  notify:
    - Restart bitnami apps

- name: install gunicorn hello_world
  copy:
    src: files/gunicorn/hello_world.py
    dest: "/opt/bitnami/apps/{{ item.key }}/hello_world.py"
  loop: "{{ APPs | dict2items }}"
  when: item.value.using_gunicorn is defined and item.value.using_gunicorn
  notify:
    - Restart bitnami apps

- name: Configure gunicorn sysconfig
  template:
    src: systemd/gunicorn_sysconfig.j2
    dest: "/etc/sysconfig/gunicorn_{{ item.key }}"
  loop: "{{ APPs | dict2items }}"
  when: item.value.using_gunicorn is defined and item.value.using_gunicorn
  #notify:
  #  - restart gunicorn service
  #  - restart gunicorn socket
  #  - restart bitnami apps

- name: create systemd gunicorn socket file
  become: yes
  template:
    src: templates/systemd/gunicorn_socket.j2
    dest: "/usr/lib/systemd/system/gunicorn_{{ item.key }}.socket"
  loop: "{{ APPs | dict2items }}"
  when: item.value.using_gunicorn is defined and item.value.using_gunicorn
  #notify:
  #  - restart gunicorn service
  #  - restart gunicorn socket
  #  - restart bitnami apps

- name: create systemd gunicorn service file
  become: yes
  template:
    src: templates/systemd/gunicorn_service.j2
    dest: "/usr/lib/systemd/system/gunicorn_{{ item.key }}.service"
  loop: "{{ APPs | dict2items }}"
  when: item.value.using_gunicorn is defined and item.value.using_gunicorn
  #notify:
  #  - restart gunicorn service
  #  - restart gunicorn socket
  #  - restart bitnami apps

# vim: ai et ts=2 sw=2 sts=2 nu
