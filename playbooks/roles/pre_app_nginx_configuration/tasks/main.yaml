---
- name: set up dirs, including perms, owner, groups
  become: yes
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0775'
    owner: bitnami
    group: daemon
  with_items:
    - /opt/bitnami/nginx/conf/server_blocks
    - /opt/bitnami/apps
    - /opt/bitnami/apps/acme_validation/.well-known/acme-challenge
    - /opt/bitnami/apps/502

- name: remove original wordpress directory
  become: yes
  ansible.builtin.file:
    path: /opt/bitnami/wordpress
    state: absent

- name: create symbolic link for apps dir
  ansible.builtin.file:
    src: /opt/bitnami/apps
    dest: /home/bitnami/apps
    state: link
  when: not ansible_check_mode

- name: remove orig nginx conf
  become: yes
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /opt/bitnami/nginx/conf/server_blocks/default-https-server-block.conf
    - /opt/bitnami/nginx/conf/server_blocks/wordpress-server-block.conf
    - /opt/bitnami/nginx/conf/server_blocks/wordpress-https-server-block.conf

- name: set php-fpm.conf to tcp/ip not unix_sock
  become: yes
  template:
    src: php-fpm.conf.j2
    dest: /opt/bitnami/nginx/conf/bitnami/php-fpm.conf
    backup: yes
  notify:
    - Restart bitnami apps

- name: set www.conf to listen on tcp/ip not unix_sock
  become: yes
  template:
    src: www.conf.j2
    dest: /opt/bitnami/php/etc/php-fpm.d/www.conf
  notify:
    - Restart bitnami apps

- name: add 502 html page
  become: yes
  copy:
    src: 502.html
    dest: /opt/bitnami/apps/502
    mode: '0775'
    owner: bitnami
    group: daemon
  when: not ansible_check_mode

#Doesn't seem to effect logging - hold for now
#- name: log_not_found present
#  become: yes
#  lineinfile:
#    path: /opt/bitnami/nginx/conf/nginx.conf
#    insertafter: 'server_tokens off;'
#    state: present
#    line: '    log_not_found off;  # inserted by Ansible'
#    backup: yes
#  notify:
#    - Restart bitnami apps
#
#- name: log_not_found absent
#  become: yes
#  lineinfile:
#    path: /opt/bitnami/nginx/conf/nginx.conf
#    state: absent
#    line: '    log_not_found on;  # inserted by Ansible'
#    backup: yes
#  notify:
#    - Restart bitnami apps

# vim: ai et ts=2 sw=2 sts=2 nu
